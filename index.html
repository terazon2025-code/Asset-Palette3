<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Asset Palette</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'Noto Sans JP', 'sans-serif'],
            },
          },
        },
      }
    </script>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.3.1",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
    "recharts": "https://esm.sh/recharts@2.12.7",
    "react-dom/": "https://esm.sh/react-dom@18.3.1/",
    "react/": "https://esm.sh/react@18.3.1/"
  }
}
</script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
// --- ライブラリのインポート ---
import React, { useState, useCallback, useRef, useEffect } from 'react';
import ReactDOM from 'react-dom/client';
import { PieChart, Pie, Cell, Tooltip, ResponsiveContainer } from 'recharts';

// --- 定数 (constants.ts) ---
const ASSET_TYPE_COLORS = {
  '国内株式': '#3b82f6', '米国株式': '#f97316', '中国株式': '#ec4899', 'アセアン株式': '#ef4444',
  '投資信託': '#22c55e', '金・プラチナ': '#eab308', '国内債券': '#6366f1', '外国債券': '#8b5cf6',
  '現金': '#6b7280', '仮想通貨': '#14b8a6',
};
const GENERAL_PALETTE = [
  '#6b21a8', '#1d4ed8', '#059669', '#d97706', '#db2777', '#64748b', '#4f46e5', '#c026d3',
];
const getTypeColor = (type) => ASSET_TYPE_COLORS[type] || '';
const getGeneralColor = (name) => {
  let hash = 0;
  for (let i = 0; i < name.length; i++) {
    hash = name.charCodeAt(i) + ((hash << 5) - hash);
  }
  return GENERAL_PALETTE[Math.abs(hash % GENERAL_PALETTE.length)];
};
const assetTypeOrder = {
  '国内株式': 1, '米国株式': 2, '中国株式': 3, 'アセアン株式': 4,
  '投資信託': 5, '金・プラチナ': 6, '国内債券': 7, '外国債券': 8,
  '現金': 98, '仮想通貨': 99,
};

// --- アイコン (components/icons.tsx) ---
const UploadIcon = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V21h18v-3.75m-18 0V12a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 12v5.25" />
  </svg>
);
const ArrowLeftIcon = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
  </svg>
);
const DownloadIcon = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
  </svg>
);
const ChevronRightIcon = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
  </svg>
);
const PlusIcon = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
    </svg>
);
const PencilIcon = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
    </svg>
);
const TrashIcon = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
    </svg>
);
const EyeIcon = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
    <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
  </svg>
);

// --- 共通ヘルパー関数 ---
const aggregateHoldingsByName = (holdings) => {
  const holdingGroups = new Map();
  for (const holding of holdings) {
      if (!holdingGroups.has(holding.name)) {
          holdingGroups.set(holding.name, { totalValue: 0, totalGainLoss: 0, type: holding.type, subHoldings: [] });
      }
      const group = holdingGroups.get(holding.name);
      group.totalValue += holding.value;
      group.totalGainLoss += holding.gainLoss;
      group.subHoldings.push(holding);
  }
  
  const aggregatedResult = [];
  for(const [name, group] of holdingGroups.entries()) {
    const subHoldingsByAccount = new Map();
    for (const subHolding of group.subHoldings) {
      if (!subHoldingsByAccount.has(subHolding.account)) {
        subHoldingsByAccount.set(subHolding.account, { value: 0, gainLoss: 0, originalHoldings: [] });
      }
      const accountGroup = subHoldingsByAccount.get(subHolding.account);
      accountGroup.value += subHolding.value;
      accountGroup.gainLoss += subHolding.gainLoss;
      accountGroup.originalHoldings.push(subHolding);
    }

    const newSubHoldings = Array.from(subHoldingsByAccount.entries()).map(([account, data]) => {
      if (data.originalHoldings.length === 1) {
        return data.originalHoldings[0];
      } else {
        return {
          id: `aggregated_${name}_${account}`, type: group.type, name: name, account: account,
          value: data.value, gainLoss: data.gainLoss,
        };
      }
    });

    aggregatedResult.push({
      name, type: group.type, totalValue: group.totalValue, totalGainLoss: group.totalGainLoss,
      subHoldings: newSubHoldings.sort((a, b) => b.value - a.value),
    });
  }

  return aggregatedResult.sort((a, b) => {
    const typeOrderA = assetTypeOrder[a.type] || 90;
    const typeOrderB = assetTypeOrder[b.type] || 90;
    if (typeOrderA !== typeOrderB) {
      return typeOrderA - typeOrderB;
    }
    return b.totalValue - a.totalValue;
  });
};


// --- コンポーネント (components/*.tsx) ---

const AddAssetModal = ({ isOpen, onClose, onSave, assetToEdit }) => {
  const [name, setName] = useState('');
  const [type, setType] = useState('');
  const [value, setValue] = useState('');
  const [gainLoss, setGainLoss] = useState('');
  const [error, setError] = useState('');
  const isEditMode = !!assetToEdit;

  useEffect(() => {
    if (isOpen) {
      if (isEditMode) {
        setName(assetToEdit.name); setType(assetToEdit.type);
        setValue(String(assetToEdit.value)); setGainLoss(String(assetToEdit.gainLoss));
      } else {
        setName(''); setType(''); setValue(''); setGainLoss('0');
      }
      setError('');
    }
  }, [isOpen, assetToEdit, isEditMode]);

  if (!isOpen) return null;

  const handleSave = () => {
    if (!name || !type || !value) {
      setError('銘柄名、種別、評価額は必須です。'); return;
    }
    const parsedValue = parseInt(value.replace(/,/g, ''), 10);
    const parsedGainLoss = parseInt((gainLoss || '0').replace(/,/g, ''), 10);
    if (isNaN(parsedValue) || isNaN(parsedGainLoss)) {
      setError('評価額と評価損益は有効な数値を入力してください。'); return;
    }
    if (isEditMode) {
        onSave({ ...assetToEdit, name, type, value: parsedValue, gainLoss: parsedGainLoss });
    } else {
        onSave({ name, type, value: parsedValue, gainLoss: parsedGainLoss });
    }
  };

  return (
    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={onClose}>
      <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-4 sm:p-6" onClick={e => e.stopPropagation()}>
        <h2 className="text-xl sm:text-2xl font-bold text-gray-900 mb-6">{isEditMode ? '資産を編集' : '資産を手入力で追加'}</h2>
        <div className="space-y-4">
          <div>
            <label htmlFor="asset-name" className="block text-sm sm:text-base font-medium text-gray-600 mb-1">銘柄名</label>
            <input type="text" id="asset-name" value={name} onChange={e => setName(e.target.value)} placeholder="例：現金, ビットコイン" className="w-full bg-white border border-gray-300 rounded-md px-3 py-2 text-base text-gray-900 focus:ring-blue-500 focus:border-blue-500" />
          </div>
          <div>
            <label htmlFor="asset-type" className="block text-sm sm:text-base font-medium text-gray-600 mb-1">種別</label>
            <input type="text" id="asset-type" value={type} onChange={e => setType(e.target.value)} placeholder="例：現金, 仮想通貨" className="w-full bg-white border border-gray-300 rounded-md px-3 py-2 text-base text-gray-900 focus:ring-blue-500 focus:border-blue-500" />
          </div>
          <div>
            <label htmlFor="asset-value" className="block text-sm sm:text-base font-medium text-gray-600 mb-1">評価額 (円)</label>
            <input type="text" id="asset-value" value={value} onChange={e => setValue(e.target.value)} placeholder="1000000" className="w-full bg-white border border-gray-300 rounded-md px-3 py-2 text-base text-gray-900 focus:ring-blue-500 focus:border-blue-500" />
          </div>
          <div>
            <label htmlFor="asset-gainloss" className="block text-sm sm:text-base font-medium text-gray-600 mb-1">評価損益 (円)</label>
            <input type="text" id="asset-gainloss" value={gainLoss} onChange={e => setGainLoss(e.target.value)} placeholder="0" className="w-full bg-white border border-gray-300 rounded-md px-3 py-2 text-base text-gray-900 focus:ring-blue-500 focus:border-blue-500" />
          </div>
        </div>
        {error && <p className="mt-4 text-sm text-red-600">{error}</p>}
        <div className="mt-6 flex justify-end space-x-3">
          <button onClick={onClose} className="px-4 py-2 text-sm sm:text-base font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">キャンセル</button>
          <button onClick={handleSave} className="px-4 py-2 text-sm sm:text-base font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">保存</button>
        </div>
      </div>
    </div>
  );
};

const SummaryCard = ({ totalValue, totalGainLoss }) => {
  const principal = totalValue - totalGainLoss;
  const gainLossRate = principal === 0 ? 0 : (totalGainLoss / principal) * 100;
  const formattedValueInteger = new Intl.NumberFormat('ja-JP', { style: 'decimal' }).format(totalValue).split('.')[0];
  const formattedGainLoss = new Intl.NumberFormat('ja-JP', { style: 'decimal', signDisplay: 'always' }).format(totalGainLoss);
  const formattedGainLossRate = `(${gainLossRate.toFixed(2)}%)`;
  const gainLossColor = totalGainLoss >= 0 ? 'text-red-600' : 'text-blue-600';

  return (
    <div className="bg-white border border-gray-200 p-4 sm:p-6 rounded-lg shadow-sm">
      <div className="flex items-center space-x-2">
        <p className="text-lg sm:text-xl font-bold text-gray-800">資産合計</p>
        <EyeIcon className="w-5 h-5 text-gray-400" />
      </div>
      <div className="mt-2 flex items-baseline justify-start">
        <p className="text-4xl sm:text-6xl font-bold text-gray-900 tracking-tight">{formattedValueInteger}</p>
        <span className="ml-1 text-xl sm:text-3xl font-medium text-gray-600">円</span>
      </div>
      <div className={`mt-2 text-lg sm:text-2xl font-semibold ${gainLossColor} flex flex-col sm:flex-row sm:items-center sm:space-x-2`}>
        <p>評価損益(率)</p>
        <div className="flex items-baseline space-x-2">
            <span>{formattedGainLoss}円</span>
            <span>{formattedGainLossRate}</span>
        </div>
      </div>
    </div>
  );
};

const PortfolioPieChart = ({ byAccount, byAssetClass, byHolding, view, onViewChange }) => {
  const CustomTooltip = ({ active, payload }) => {
    if (active && payload && payload.length) {
      const data = payload[0];
      const formattedValue = new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(data.value);
      return (
        <div className="bg-white/90 p-2 sm:p-3 rounded-md border border-gray-200 shadow-lg backdrop-blur-sm pointer-events-none">
          <p className="font-bold text-sm sm:text-base text-gray-800">{`${data.name}`}</p>
          <p className="text-gray-900 font-semibold text-sm sm:text-base">{`${formattedValue}`}</p>
          <p className="text-xs text-gray-500">{`(${((data.value / payload[0].payload.total) * 100).toFixed(2)}%)`}</p>
        </div>
      );
    }
    return null;
  };
  const renderCustomizedLabel = (props) => {
      const { cx, cy, midAngle, outerRadius, name, value, percent } = props;
      if (percent < 0.01) return null;
      const isMobile = window.innerWidth < 640;
      const RADIAN = Math.PI / 180;
      const sin = Math.sin(-RADIAN * midAngle);
      const cos = Math.cos(-RADIAN * midAngle);
      const radius = outerRadius + (isMobile ? 15 : 35);
      const x = cx + radius * cos;
      const y = cy + radius * sin;
      const ex = x + (cos >= 0 ? 1 : -1) * (isMobile ? 12 : 22);
      const textAnchor = cos >= 0 ? 'start' : 'end';
      return (
          <g>
              <path d={`M${cx + (outerRadius+5) * cos},${cy + (outerRadius+5) * sin}L${x},${y}L${ex},${y}`} stroke="#9ca3af" fill="none" strokeWidth={1} />
              <text x={ex + (cos >= 0 ? 1 : -1) * 6} y={y} textAnchor={textAnchor} fill="#1f2937" dominantBaseline="central" className="text-sm sm:text-2xl font-bold">{name}</text>
              <text x={ex + (cos >= 0 ? 1 : -1) * 6} y={y} dy={isMobile ? 18 : 30} textAnchor={textAnchor} fill="#374151" className="text-xs sm:text-xl">
                  {`${new Intl.NumberFormat('ja-JP').format(value)}円 `}
                  <tspan fill="#16a34a" className="font-semibold">{`(${(percent * 100).toFixed(1)}%)`}</tspan>
              </text>
          </g>
      );
  };
  const data = view === 'assetClass' ? byAssetClass : view === 'account' ? byAccount : byHolding;
  const total = data.reduce((sum, entry) => sum + entry.value, 0);
  const chartData = data.map(item => ({ ...item, total }));
  const getColor = (entry) => {
    if (view === 'assetClass') return getTypeColor(entry.name) || getGeneralColor(entry.name);
    if (view === 'holding') return getTypeColor(entry.type) || getGeneralColor(entry.name);
    return getGeneralColor(entry.name);
  };

  return (
    <div className="bg-white border border-gray-200 p-2 sm:p-6 rounded-lg h-full flex flex-col shadow-sm">
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-4 px-2 sm:px-0">
        <h2 className="text-xl sm:text-3xl font-bold text-gray-900">アセットアロケーション</h2>
        <div className="flex text-sm bg-gray-200 p-1 rounded-lg self-stretch sm:self-auto">
          <button onClick={() => onViewChange('assetClass')} className={`flex-1 px-2 py-1.5 rounded-md transition-colors text-sm sm:text-base font-bold text-center ${view === 'assetClass' ? 'bg-white text-gray-800 shadow' : 'text-gray-500 hover:text-gray-700'}`}>資産クラス別</button>
          <button onClick={() => onViewChange('account')} className={`flex-1 px-2 py-1.5 rounded-md transition-colors text-sm sm:text-base font-bold text-center ${view === 'account' ? 'bg-white text-gray-800 shadow' : 'text-gray-500 hover:text-gray-700'}`}>口座別</button>
          <button onClick={() => onViewChange('holding')} className={`flex-1 px-2 py-1.5 rounded-md transition-colors text-sm sm:text-base font-bold text-center ${view === 'holding' ? 'bg-white text-gray-800 shadow' : 'text-gray-500 hover:text-gray-700'}`}>保有名柄別</button>
        </div>
      </div>
      <div className="relative flex-grow w-full h-[28rem] sm:h-[42rem]">
        <ResponsiveContainer width="100%" height="100%">
          <PieChart margin={{ top: 30, right: 20, bottom: 30, left: 20 }}>
            <Tooltip content={<CustomTooltip />} wrapperStyle={{ outline: 'none' }} offset={25} isAnimationActive={false} animationDuration={0} />
            <Pie data={chartData} cx="50%" cy="50%" innerRadius={'65%'} outerRadius={'80%'} fill="#8884d8" paddingAngle={3} dataKey="value" nameKey="name" labelLine={false} label={renderCustomizedLabel}>
              {chartData.map((entry, index) => <Cell key={`cell-${index}`} fill={getColor(entry)} />)}
            </Pie>
          </PieChart>
        </ResponsiveContainer>
      </div>
    </div>
  );
};

const HoldingsTable = ({ aggregatedHoldings, byAssetClass, byAccount, totalValue, view, onEdit, onDelete, isReadOnly }) => {
  const [expandedGroups, setExpandedGroups] = useState(new Set());
  const calculateGainLossRate = (value, gainLoss) => {
      const principal = value - gainLoss;
      if (principal === 0 || principal === -0) return gainLoss > 0 ? 100.0 : 0;
      return (gainLoss / principal) * 100;
  };
  const currencyFormat = (value) => new Intl.NumberFormat('ja-JP').format(value);
  const signedCurrencyFormat = (value) => new Intl.NumberFormat('ja-JP', { signDisplay: 'always' }).format(value);
  const gainLossColor = (val) => val >= 0 ? 'text-red-600' : 'text-blue-600';
  
  const AggregatedHoldingCard = ({ aggHolding, totalValue, onEdit, onDelete, isReadOnly, isSubRow = false }) => {
      const [isExpanded, setIsExpanded] = useState(false);
      const gainLossRate = calculateGainLossRate(aggHolding.totalValue, aggHolding.totalGainLoss);
      const percentageOfTotal = (aggHolding.totalValue / totalValue) * 100;
      const hasSubHoldings = aggHolding.subHoldings.length > 1;
      const isSingleManualEntry = aggHolding.subHoldings.length === 1 && aggHolding.subHoldings[0].account === '手入力';
      const canEditSingle = !isReadOnly && isSingleManualEntry;
      const typeColor = getTypeColor(aggHolding.type) || getGeneralColor(aggHolding.type);
      return (
          <div className={isSubRow ? "bg-gray-50 border border-gray-200 rounded-lg" : "bg-white border border-gray-200 rounded-lg"}>
            <div className={`p-3 sm:p-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4 ${hasSubHoldings ? 'cursor-pointer hover:bg-gray-100' : ''}`} onClick={hasSubHoldings ? () => setIsExpanded(p => !p) : undefined}>
              <div className="flex-1 min-w-0">
                  <div className="flex items-center">
                     <span className="w-3 h-3 sm:w-4 sm:h-4 rounded-full mr-2 sm:mr-3 flex-shrink-0" style={{ backgroundColor: typeColor }}></span>
                     <p className="text-base sm:text-2xl text-gray-500 truncate">{aggHolding.type}</p>
                  </div>
                  <p className="text-xl sm:text-4xl font-bold text-gray-900 mt-1 truncate">{aggHolding.name}</p>
              </div>
              <div className="flex-shrink-0 flex flex-col items-start sm:items-end gap-1 sm:gap-2 mt-2 sm:mt-0 w-full sm:w-auto">
                  <div className="text-right w-full">
                      <p className="text-sm sm:text-xl text-gray-500">評価額 (構成比)</p>
                      <div className="flex items-baseline justify-end">
                        <p className="text-2xl sm:text-5xl font-bold text-gray-900">{currencyFormat(aggHolding.totalValue)}</p>
                        <span className="text-lg sm:text-3xl font-medium text-gray-600 ml-1">円</span>
                        <span className="text-base sm:text-2xl text-green-600 font-semibold ml-2 sm:ml-4 min-w-[70px] sm:min-w-[90px]">({percentageOfTotal.toFixed(1)}%)</span>
                      </div>
                  </div>
                  <div className="text-right w-full">
                      <p className="text-sm sm:text-xl text-gray-500">評価損益 (率)</p>
                      <div className={`${gainLossColor(aggHolding.totalGainLoss)} text-base sm:text-2xl font-semibold flex items-center justify-end space-x-2 sm:space-x-3`}>
                        <span>{signedCurrencyFormat(aggHolding.totalGainLoss)}円</span>
                        <span>({gainLossRate.toFixed(2)}%)</span>
                      </div>
                  </div>
              </div>
              <div className="flex-shrink-0 sm:ml-4 flex items-center justify-end space-x-2 self-end sm:self-center">
                  {canEditSingle && (<>
                      <button onClick={(e) => { e.stopPropagation(); onEdit(aggHolding.subHoldings[0]); }} className="text-gray-400 hover:text-blue-600 p-1"><PencilIcon className="w-5 h-5 sm:w-6 sm:h-6" /></button>
                      <button onClick={(e) => { e.stopPropagation(); onDelete(aggHolding.subHoldings[0].id); }} className="text-gray-400 hover:text-red-600 p-1"><TrashIcon className="w-5 h-5 sm:w-6 sm:h-6" /></button>
                  </>)}
                  {hasSubHoldings && <ChevronRightIcon className={`w-6 h-6 text-gray-400 transition-transform ${isExpanded ? 'rotate-90' : ''}`} />}
              </div>
            </div>
            {isExpanded && hasSubHoldings && (
              <div className="border-t border-gray-200 bg-gray-100 px-3 sm:px-6 py-4 sm:py-6 space-y-4">
                {aggHolding.subHoldings.map((sub) => {
                  const subGainLossRate = calculateGainLossRate(sub.value, sub.gainLoss);
                  const canEditSub = !isReadOnly && sub.account === '手入力';
                  return (
                     <div key={sub.id} className="flex items-center justify-between">
                       <p className="text-lg sm:text-2xl text-gray-700 font-medium">{sub.account}</p>
                       <div className="flex items-center space-x-2 sm:space-x-4">
                         <div className="text-right">
                            <p className="text-xs sm:text-lg text-gray-500">評価額</p>
                            <p className="text-base sm:text-3xl font-bold text-gray-800">{currencyFormat(sub.value)}円</p>
                            <p className="text-xs sm:text-lg text-gray-500 mt-1">評価損益 (率)</p>
                            <p className={`${gainLossColor(sub.gainLoss)} text-sm sm:text-2xl font-semibold`}>{signedCurrencyFormat(sub.gainLoss)} ({subGainLossRate.toFixed(2)}%)</p>
                         </div>
                         {canEditSub && (
                           <div className="flex items-center space-x-1">
                             <button onClick={() => onEdit(sub)} className="text-gray-400 hover:text-blue-600 p-1"><PencilIcon className="w-5 h-5 sm:w-6 sm:h-6" /></button>
                             <button onClick={() => onDelete(sub.id)} className="text-gray-400 hover:text-red-600 p-1"><TrashIcon className="w-5 h-5 sm:w-6 sm:h-6" /></button>
                           </div>
                         )}
                       </div>
                     </div>
                  );
                })}
              </div>
            )}
          </div>
      );
  };
  const toggleGroup = (name) => {
    setExpandedGroups(prev => {
      const newSet = new Set(prev);
      if (newSet.has(name)) newSet.delete(name); else newSet.add(name);
      return newSet;
    });
  };
  const title = view === 'assetClass' ? '資産クラス別' : view === 'account' ? '口座別' : '保有商品';
  
  return (
    <div className="bg-white border border-gray-200 p-3 sm:p-6 rounded-lg shadow-sm flex flex-col">
      <h2 className="text-2xl sm:text-4xl font-bold text-gray-900 mb-4 sm:mb-6 flex-shrink-0">{title}</h2>
      <div className="space-y-3 sm:space-y-4">
        {view === 'holding' && aggregatedHoldings.map((agg) => (
          <AggregatedHoldingCard key={agg.name} aggHolding={agg} totalValue={totalValue} onEdit={onEdit} onDelete={onDelete} isReadOnly={isReadOnly} />
        ))}
        {view !== 'holding' && (view === 'assetClass' ? byAssetClass : byAccount).map(group => {
            const isExpanded = expandedGroups.has(group.name);
            const gainLossRate = calculateGainLossRate(group.value, group.gainLoss);
            const percentageOfTotal = (group.value / totalValue) * 100;
            const groupColor = view === 'assetClass' ? getTypeColor(group.name) || getGeneralColor(group.name) : getGeneralColor(group.name);
            return (
                <div key={group.name} className="bg-white border border-gray-200 rounded-lg">
                    <div className={`p-3 sm:p-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4 ${group.aggregatedHoldings.length ? 'cursor-pointer hover:bg-gray-50' : ''}`} onClick={() => group.aggregatedHoldings.length && toggleGroup(group.name)}>
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center">
                                <span className="w-3 h-3 sm:w-4 sm:h-4 rounded-full mr-2 sm:mr-3 flex-shrink-0" style={{ backgroundColor: groupColor }}></span>
                                <p className="text-xl sm:text-4xl font-bold text-gray-900 truncate">{group.name}</p>
                            </div>
                        </div>
                        <div className="flex-shrink-0 flex flex-col items-start sm:items-end gap-1 sm:gap-2 mt-2 sm:mt-0 w-full sm:w-auto">
                            <div className="text-right w-full">
                                <p className="text-sm sm:text-xl text-gray-500">評価額 (構成比)</p>
                                <div className="flex items-baseline justify-end">
                                    <p className="text-2xl sm:text-5xl font-bold text-gray-900">{currencyFormat(group.value)}</p>
                                    <span className="text-lg sm:text-3xl font-medium text-gray-600 ml-1">円</span>
                                    <span className="text-base sm:text-2xl text-green-600 font-semibold ml-2 sm:ml-4 min-w-[70px] sm:min-w-[90px]">({percentageOfTotal.toFixed(1)}%)</span>
                                </div>
                            </div>
                            <div className="text-right w-full">
                                <p className="text-sm sm:text-xl text-gray-500">評価損益 (率)</p>
                                <div className={`${gainLossColor(group.gainLoss)} text-base sm:text-2xl font-semibold flex items-center justify-end space-x-2 sm:space-x-3`}>
                                    <span>{signedCurrencyFormat(group.gainLoss)}円</span>
                                    <span>({gainLossRate.toFixed(2)}%)</span>
                                </div>
                            </div>
                        </div>
                        <div className="flex-shrink-0 sm:ml-4 flex items-center justify-end self-end sm:self-center">
                             {group.aggregatedHoldings.length > 0 && <ChevronRightIcon className={`w-6 h-6 text-gray-400 transition-transform ${isExpanded ? 'rotate-90' : ''}`} />}
                        </div>
                    </div>
                    {isExpanded && group.aggregatedHoldings.length > 0 && (
                        <div className="border-t border-gray-200 bg-gray-50/50 px-3 sm:px-6 py-4 space-y-3 sm:space-y-4">
                            {group.aggregatedHoldings.map(agg => (
                                <AggregatedHoldingCard key={agg.name} aggHolding={agg} totalValue={totalValue} onEdit={onEdit} onDelete={onDelete} isReadOnly={isReadOnly} isSubRow={true} />
                            ))}
                        </div>
                    )}
                </div>
            )
        })}
      </div>
    </div>
  );
};

const Header = ({ onReset, onExport, onAddAsset, isAddDisabled }) => {
    return (
        <header className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <h1 className="text-3xl sm:text-4xl font-bold text-gray-900">Asset Palette</h1>
            <div className="flex items-center space-x-2 self-end sm:self-center">
                <button onClick={onReset} className="flex items-center space-x-1 sm:space-x-2 px-3 py-2 text-sm sm:text-base font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors shadow-sm">
                    <ArrowLeftIcon className="w-5 h-5" /><span className="hidden sm:inline">戻る</span>
                </button>
                 <button onClick={onAddAsset} disabled={isAddDisabled} className="flex items-center space-x-1 sm:space-x-2 px-3 py-2 text-sm sm:text-base font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-sm">
                    <PlusIcon className="w-5 h-5" /><span className="hidden sm:inline">追加</span>
                </button>
                <button onClick={onExport} className="flex items-center space-x-1 sm:space-x-2 px-3 py-2 text-sm sm:text-base font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors shadow-sm">
                    <DownloadIcon className="w-5 h-5" /><span className="hidden sm:inline">保存</span>
                </button>
            </div>
        </header>
    );
};

const Dashboard = ({ individualPortfolios, combinedPortfolio, onReset, onManualAdd, onUpdateAsset, onDeleteAsset }) => {
  const dashboardRef = useRef(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingAsset, setEditingAsset] = useState(null);
  const [activePortfolioTab, setActivePortfolioTab] = useState('combined');
  const [chartView, setChartView] = useState('assetClass');

  const handleExport = useCallback(() => {
    if (!dashboardRef.current || !window.htmlToImage) return;
    window.htmlToImage.toPng(dashboardRef.current, { backgroundColor: '#F9FAFB', pixelRatio: 2, style: { fontFamily: 'Inter, Noto Sans JP, sans-serif' } })
      .then((dataUrl) => {
        const link = document.createElement('a');
        link.download = 'asset-palette.png';
        link.href = dataUrl;
        link.click();
      }).catch((err) => { console.error('oops, something went wrong!', err); alert('画像の書き出しに失敗しました。'); });
  }, []);

  const isCombinedView = activePortfolioTab === 'combined';
  const currentData = isCombinedView ? combinedPortfolio : individualPortfolios[activePortfolioTab].data;
  const currentPortfolioIndex = isCombinedView ? -1 : activePortfolioTab;

  const handleOpenAddModal = () => { if (isCombinedView) return; setEditingAsset(null); setIsModalOpen(true); };
  const handleOpenEditModal = (asset) => { if (isCombinedView) return; setEditingAsset(asset); setIsModalOpen(true); };
  const handleDelete = (assetId) => {
    if (isCombinedView) return;
    if (window.confirm('この資産を削除してもよろしいですか？')) onDeleteAsset(currentPortfolioIndex, assetId);
  };
  const handleSaveAsset = (assetData) => {
    if (isCombinedView) return;
    if ('id' in assetData) onUpdateAsset(currentPortfolioIndex, assetData); else onManualAdd(currentPortfolioIndex, assetData);
    setIsModalOpen(false);
  }
  const getTabClass = (isActive) => `px-3 md:px-4 py-2 sm:py-3 text-base sm:text-xl font-bold whitespace-nowrap transition-colors relative ${isActive ? 'text-gray-900' : 'text-gray-400 hover:text-gray-600'}`;

  return (
    <>
      <div className="p-2 md:p-6 lg:p-8 bg-gray-50 min-h-screen">
        <div className="max-w-7xl mx-auto">
          <Header onReset={onReset} onExport={handleExport} onAddAsset={handleOpenAddModal} isAddDisabled={isCombinedView} />
          <nav className="mt-4 sm:mt-6 border-b border-gray-200">
             <div className="flex space-x-2 md:space-x-8 -mb-px overflow-x-auto">
                <button className={getTabClass(isCombinedView)} onClick={() => setActivePortfolioTab('combined')}>合算{isCombinedView && <span className="absolute bottom-0 left-0 w-full h-0.5 sm:h-1 bg-blue-600 rounded-t-full"></span>}</button>
                {individualPortfolios.map((p, index) => (
                  <button key={p.name} className={getTabClass(activePortfolioTab === index)} onClick={() => setActivePortfolioTab(index)}>{p.name}{activePortfolioTab === index && <span className="absolute bottom-0 left-0 w-full h-0.5 sm:h-1 bg-blue-600 rounded-t-full"></span>}</button>
                ))}
            </div>
          </nav>
          <main ref={dashboardRef} className="pt-4 md:pt-8">
            <SummaryCard totalValue={currentData.totalValue} totalGainLoss={currentData.totalGainLoss} />
            <div className="flex flex-col gap-4 md:gap-8 mt-4 md:mt-8">
                <PortfolioPieChart byAccount={currentData.byAccount} byAssetClass={currentData.byAssetClass} byHolding={currentData.byHoldingForPie} view={chartView} onViewChange={setChartView} />
                <HoldingsTable aggregatedHoldings={currentData.aggregatedHoldings} byAccount={currentData.byAccount} byAssetClass={currentData.byAssetClass} totalValue={currentData.totalValue} view={chartView} onEdit={handleOpenEditModal} onDelete={handleDelete} isReadOnly={isCombinedView} />
            </div>
          </main>
        </div>
        <footer className="text-center py-8 text-gray-400 text-sm"><p>Generated by Asset Palette</p></footer>
      </div>
      <AddAssetModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSaveAsset} assetToEdit={editingAsset} />
    </>
  );
};

const FileUpload = ({ onDataLoaded }) => {
  const [files, setFiles] = useState([]);
  const [error, setError] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [isDragging, setIsDragging] = useState(false);
  const fileInputRef = useRef(null);
  const nextId = useRef(0);

  const calculatePortfolioData = (holdings) => {
    const totalValue = holdings.reduce((sum, h) => sum + h.value, 0);
    const totalGainLoss = holdings.reduce((sum, h) => sum + h.gainLoss, 0);
    const aggregatedHoldings = aggregateHoldingsByName(holdings);
    const assetClassGroups = new Map();
    holdings.forEach(h => {
      if (!assetClassGroups.has(h.type)) assetClassGroups.set(h.type, []);
      assetClassGroups.get(h.type).push(h);
    });
    const byAssetClass = Array.from(assetClassGroups.entries()).map(([name, holdingsInGroup]) => ({
      name, value: holdingsInGroup.reduce((sum, h) => sum + h.value, 0), gainLoss: holdingsInGroup.reduce((sum, h) => sum + h.gainLoss, 0),
      aggregatedHoldings: aggregateHoldingsByName(holdingsInGroup)
    })).sort((a,b) => b.value - a.value);
    const accountGroups = new Map();
    holdings.forEach(h => {
      const key = h.account === '手入力' ? h.type : h.account;
      if (!accountGroups.has(key)) accountGroups.set(key, []);
      accountGroups.get(key).push(h);
    });
    const byAccount = Array.from(accountGroups.entries()).map(([name, holdingsInGroup]) => ({
      name, value: holdingsInGroup.reduce((sum, h) => sum + h.value, 0), gainLoss: holdingsInGroup.reduce((sum, h) => sum + h.gainLoss, 0),
      aggregatedHoldings: aggregateHoldingsByName(holdingsInGroup)
    })).sort((a,b) => b.value - a.value);
    const byHoldingForPie = aggregatedHoldings.map(h => ({ name: h.name, value: h.totalValue, type: h.type })).sort((a,b) => b.value - a.value);
    return { totalValue, totalGainLoss, aggregatedHoldings, byAccount, byAssetClass, byHoldingForPie, holdings };
  };
  const parseSingleFile = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const buffer = event.target?.result;
          if (!buffer) throw new Error("ファイルの読み込みに失敗しました。");
          let text = null;
          for (const decoderInfo of [{ encoding: 'utf-8' }, { encoding: 'shift_jis' }, { encoding: 'euc-jp' }]) {
              try {
                  const decodedText = new TextDecoder(decoderInfo.encoding).decode(buffer);
                  if (decodedText.includes('保有商品詳細')) { text = decodedText; break; }
              } catch (e) { /* ignore */ }
          }
          if (!text) throw new Error('「保有商品詳細」セクションが見つかりません。楽天証券からダウンロードした資産残高（CSV）ファイルであることを確認してください。');
          if (text.charCodeAt(0) === 0xFEFF) text = text.substring(1);
          const lines = text.split(/\r\n|\n/).filter(line => line.trim() !== '');
          const startIndex = lines.findIndex(line => line.includes('保有商品詳細'));
          if (startIndex === -1) throw new Error('CSV解析中に「保有商品詳細」セクションが見失われました。');
          
          const parseCsvLine = (line) => {
              const result = []; let field = ''; let inQuotes = false; let i = 0;
              while (i < line.length) {
                  const char = line[i];
                  if (inQuotes) {
                      if (char === '"') { if (i + 1 < line.length && line[i + 1] === '"') { field += '"'; i++; } else { inQuotes = false; } } else { field += char; }
                  } else {
                      if (char === '"') { inQuotes = true; } else if (char === ',') { result.push(field); field = ''; } else { field += char; }
                  } i++;
              } result.push(field); return result;
          };
          const headers = parseCsvLine(lines[startIndex + 1]).map(h => h.trim());
          const findHeaderIndex = (headers, names) => { for (const name of names) { const i = headers.indexOf(name); if (i !== -1) return i; } return -1; };
          const typeIndex = findHeaderIndex(headers, ['種別']);
          const nameIndex = findHeaderIndex(headers, ['銘柄名', '銘柄']);
          const accountIndex = findHeaderIndex(headers, ['口座']);
          const valueIndex = findHeaderIndex(headers, ['評価額', '時価評価額[円]']);
          const gainLossIndex = findHeaderIndex(headers, ['評価損益[円]']);
          const missing = [{ n: ['種別'], i: typeIndex }, { n: ['銘柄名', '銘柄'], i: nameIndex }, { n: ['口座'], i: accountIndex }, { n: ['評価額', '時価評価額[円]'], i: valueIndex }, { n: ['評価損益[円]'], i: gainLossIndex }].filter(h => h.i === -1).map(h => h.n.join('/'));
          if (missing.length > 0) throw new Error(`必須の列が見つかりません: ${missing.join(', ')}。`);
          
          const holdings = [];
          for (let i = startIndex + 2; i < lines.length; i++) {
              if (lines[i].startsWith('■')) continue;
              const columns = parseCsvLine(lines[i]).map(c => c.trim());
              if (columns.length < Math.max(typeIndex, nameIndex, accountIndex, valueIndex, gainLossIndex) + 1) continue;
              const value = parseInt((columns[valueIndex] || '0').replace(/,/g, ''), 10);
              const gainLoss = parseInt((columns[gainLossIndex] || '0').replace(/,/g, ''), 10);
              if (!isNaN(value) && !isNaN(gainLoss) && columns[typeIndex] && columns[nameIndex] && columns[accountIndex]) {
                  holdings.push({ id: `csv_${file.name}_${i}`, type: columns[typeIndex], name: columns[nameIndex], account: columns[accountIndex], value, gainLoss });
              }
          }
          resolve(holdings);
        } catch (e) { reject(e); }
      };
      reader.onerror = () => reject(new Error('ファイルの読み込みに失敗しました。'));
      reader.readAsArrayBuffer(file);
    });
  };
  const addFiles = useCallback((newFiles) => {
    setError(null);
    const csvFiles = Array.from(newFiles).filter(f => f.name.toLowerCase().endsWith('.csv'));
    if (csvFiles.length === 0) { setError('有効なCSVファイルがありません。'); return; }
    const newFileEntries = csvFiles.map((file, index) => ({ id: nextId.current++, file, name: `ポートフォリオ ${files.length + index + 1}` }));
    setFiles(prev => [...prev, ...newFileEntries]);
  }, [files.length]);
  const handleFileChange = (e) => { if (e.target.files) { addFiles(e.target.files); e.target.value = ''; } };
  const handleDrop = (e) => { e.preventDefault(); e.stopPropagation(); setIsDragging(false); if (e.dataTransfer.files) addFiles(e.dataTransfer.files); };
  const handleDragEnter = (e) => { e.preventDefault(); e.stopPropagation(); setIsDragging(true); };
  const handleDragLeave = (e) => { e.preventDefault(); e.stopPropagation(); setIsDragging(false); };
  const handleDragOver = (e) => { e.preventDefault(); e.stopPropagation(); };
  const handleNameChange = (id, newName) => { setFiles(prev => prev.map(f => f.id === id ? { ...f, name: newName } : f)); };
  const handleRemoveFile = (id) => { setFiles(prev => prev.filter(f => f.id !== id)); };
  const processAllFiles = async () => {
    if (files.length === 0) { setError('CSVファイルを追加してください。'); return; }
    setIsLoading(true); setError(null);
    const results = [];
    for (const fileWithData of files) {
      try {
        const holdings = await parseSingleFile(fileWithData.file);
        if (holdings.length === 0) throw new Error(`'${fileWithData.file.name}' から保有商品データを読み込めませんでした。`);
        results.push({ name: fileWithData.name, data: calculatePortfolioData(holdings) });
      } catch (e) {
        setError(`エラー (${fileWithData.file.name}): ${e.message}`); setIsLoading(false); return;
      }
    }
    onDataLoaded(results);
  };

  return (
    <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-100">
      <div className="text-center max-w-2xl mx-auto">
        <h1 className="text-4xl sm:text-5xl md:text-6xl font-bold text-gray-900">Asset Palette</h1>
        <p className="mt-4 text-lg sm:text-xl md:text-2xl text-gray-600">CSVを放り込むだけ。あなたの資産を、一枚の絵画に。</p>
      </div>
      <div className="w-full max-w-2xl mt-12">
        <div className="bg-white border border-gray-200 rounded-lg p-4 sm:p-6 shadow-sm">
          <div onDrop={handleDrop} onDragEnter={handleDragEnter} onDragLeave={handleDragLeave} onDragOver={handleDragOver} className={`flex justify-center items-center w-full min-h-[12rem] px-4 transition border-2 border-dashed rounded-md cursor-pointer hover:border-blue-500 focus:outline-none ${isDragging ? 'border-blue-500 bg-blue-50' : 'border-gray-300'}`} onClick={() => fileInputRef.current?.click()}>
            <input type="file" accept=".csv" onChange={handleFileChange} className="hidden" ref={fileInputRef} multiple />
            <span className="flex flex-col items-center space-y-2 text-center">
              <UploadIcon className="w-10 h-10 sm:w-12 sm:h-12 text-gray-400" />
              <span className="text-base sm:text-lg font-medium text-gray-700">
                <span className="text-blue-600 font-semibold">CSVファイル</span>をドラッグ＆ドロップ
              </span>
              <span className="text-sm sm:text-base text-gray-500">またはクリックして選択 (複数可)</span>
            </span>
          </div>
          {files.length > 0 && (
            <div className="mt-6 space-y-3">
              {files.map(f => (
                <div key={f.id} className="flex items-center space-x-2 sm:space-x-3 bg-gray-100 p-2 rounded-md border border-gray-200">
                  <input type="text" value={f.name} onChange={(e) => handleNameChange(f.id, e.target.value)} className="flex-grow bg-transparent text-gray-900 focus:outline-none focus:ring-0 border-none p-2 text-sm sm:text-base" placeholder="ポートフォリオ名 (例: 夫, 妻)" />
                  <span className="text-sm sm:text-base text-gray-500 truncate flex-shrink-0" style={{maxWidth: '120px'}}>{f.file.name}</span>
                  <button onClick={() => handleRemoveFile(f.id)} className="text-gray-400 hover:text-red-500"><TrashIcon className="w-5 h-5"/></button>
                </div>
              ))}
            </div>
          )}
        </div>
        <div className="mt-6 flex flex-col items-center">
            <button onClick={processAllFiles} disabled={isLoading || files.length === 0} className="w-full max-w-sm px-8 py-3 sm:py-4 text-base sm:text-lg font-bold text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center shadow-sm">
              {isLoading ? (<><div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div><span>解析中...</span></>) : 'ポートフォリオを作成'}
            </button>
            {error && <p className="mt-4 text-red-700 bg-red-100 border border-red-200 px-4 py-2 rounded-md w-full text-center text-sm">{error}</p>}
        </div>
      </div>
    </div>
  );
};


// --- メインアプリケーション (App.tsx) ---
const App = () => {
  const [appState, setAppState] = useState(null);
  
  const recalculatePortfolio = (allHoldings) => {
    const totalValue = allHoldings.reduce((sum, h) => sum + h.value, 0);
    const totalGainLoss = allHoldings.reduce((sum, h) => sum + h.gainLoss, 0);
    const aggregatedHoldings = aggregateHoldingsByName(allHoldings);
    const assetClassGroups = new Map();
    allHoldings.forEach(h => {
      if (!assetClassGroups.has(h.type)) assetClassGroups.set(h.type, []);
      assetClassGroups.get(h.type).push(h);
    });
    const byAssetClass = Array.from(assetClassGroups.entries()).map(([name, holdings]) => ({
      name, value: holdings.reduce((sum, h) => sum + h.value, 0), gainLoss: holdings.reduce((sum, h) => sum + h.gainLoss, 0),
      aggregatedHoldings: aggregateHoldingsByName(holdings)
    })).sort((a,b) => b.value - a.value);
    const accountGroups = new Map();
    allHoldings.forEach(h => {
      const key = h.account === '手入力' ? h.type : h.account;
      if (!accountGroups.has(key)) accountGroups.set(key, []);
      accountGroups.get(key).push(h);
    });
    const byAccount = Array.from(accountGroups.entries()).map(([name, holdings]) => ({
      name, value: holdings.reduce((sum, h) => sum + h.value, 0), gainLoss: holdings.reduce((sum, h) => sum + h.gainLoss, 0),
      aggregatedHoldings: aggregateHoldingsByName(holdings)
    })).sort((a,b) => b.value - a.value);
    const byHoldingForPie = aggregatedHoldings.map(h => ({ name: h.name, value: h.totalValue, type: h.type })).sort((a, b) => b.value - a.value);
    return { totalValue, totalGainLoss, aggregatedHoldings, byAccount, byAssetClass, byHoldingForPie, holdings: allHoldings };
  };

  const handleDataLoaded = useCallback((portfolios) => {
    const allHoldings = portfolios.flatMap(p => p.data.holdings);
    const combinedData = recalculatePortfolio(allHoldings);
    setAppState({ individual: portfolios, combined: combinedData });
  }, []);

  const handleReset = useCallback(() => setAppState(null), []);
  const handleStateUpdate = useCallback((updateFn) => {
    setAppState(prevState => {
      if (!prevState) return null;
      const updatedIndividual = updateFn(prevState.individual);
      const allHoldings = updatedIndividual.flatMap(p => p.data.holdings);
      const combinedData = recalculatePortfolio(allHoldings);
      return { individual: updatedIndividual, combined: combinedData };
    });
  }, []);
  const handleManualAdd = useCallback((portfolioIndex, newAssetData) => {
    handleStateUpdate(individual => {
      const newAsset = { ...newAssetData, id: `manual_${Date.now()}`, account: '手入力' };
      const updated = [...individual];
      const target = updated[portfolioIndex];
      const updatedHoldings = [...target.data.holdings, newAsset];
      updated[portfolioIndex] = { ...target, data: recalculatePortfolio(updatedHoldings) };
      return updated;
    });
  }, [handleStateUpdate]);
  const handleUpdateAsset = useCallback((portfolioIndex, updatedAsset) => {
    handleStateUpdate(individual => {
      const updated = [...individual];
      const target = updated[portfolioIndex];
      const updatedHoldings = target.data.holdings.map(h => h.id === updatedAsset.id ? updatedAsset : h);
      updated[portfolioIndex] = { ...target, data: recalculatePortfolio(updatedHoldings) };
      return updated;
    });
  }, [handleStateUpdate]);
  const handleDeleteAsset = useCallback((portfolioIndex, assetId) => {
    handleStateUpdate(individual => {
      const updated = [...individual];
      const target = updated[portfolioIndex];
      const updatedHoldings = target.data.holdings.filter(h => h.id !== assetId);
      updated[portfolioIndex] = { ...target, data: recalculatePortfolio(updatedHoldings) };
      return updated;
    });
  }, [handleStateUpdate]);

  return (
    <div className="min-h-screen bg-gray-50 font-sans">
      {!appState ? (
        <FileUpload onDataLoaded={handleDataLoaded} />
      ) : (
        <Dashboard 
          individualPortfolios={appState.individual} combinedPortfolio={appState.combined}
          onReset={handleReset} onManualAdd={handleManualAdd} onUpdateAsset={handleUpdateAsset} onDeleteAsset={handleDeleteAsset}
        />
      )}
    </div>
  );
};

// --- アプリケーションの起動 (index.tsx) ---
const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}
const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);

    </script>
  </body>
</html>